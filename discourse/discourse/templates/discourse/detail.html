{% extends 'base.html' %}

<!-- loading static -->


{% block static %}
{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'discourse/css/detail.css' %}">

<link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
{% endblock %}

{% block html %}
<div class="container mt-5 mb-5">
    <div class="row">
        <div class="col-md-6 offset-md-3" id="timeline-discourse">
            <h2>[[ topic.topic ]]</h2> 
            <ul class="timeline">
                <li v-for="comment in comments">
                    <a target="_blank"><b>[[ comment.author ]]</b></a>
                    <a href="#" class="float-right">[[ comment.timestamp ]]</a>
                    <p id='text_of_comments'>[[ comment.text ]]</p>
                    <span v-on:click='send_like([[ comment.id ]], [[ comment.likes ]],[[comment.send_like_api]], [[ comment.unlike_comment_api ]])'> Likes [[ get_likes_of_comments(0) ]]</span>
                </li>
            </ul>
            {% if user.is_authenticated %}
            <div id='sep'>
                <hr>
            </div>
            <div id='comment-field'>
                <form id='send_comment_form' method="post" @submit.prevent="onSubmit">
                    {% csrf_token %}
                    <textarea class="form-control" name='text' id='text' v-model="text"></textarea>
                    <div id='submit_button'>
                        <input type='submit' id='submit_button' value='Go'class="btn btn-dark">
                    </div>
                </form>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="text-muted mt-5 mb-5 text-center small">by : <a class="text-muted" target="_blank" href="http://totoprayogo.com">totoprayogo.com</a></div>


<script type="text/javascript">
    topic_info_api = '{{ info }}'
    comments_api = '{{ comments }}'
    send_comment_api = '{{ send_comment_link }}'

    vm = new Vue({
        delimiters: ["[[", "]]"],
        el: '#timeline-discourse',
        data:{
            topic: null,
            comments: null,
            text: null,
            liked:null,

            comments_and_likes: {},
        },
        mounted(){
            axios.get(topic_info_api).then(response => (this.topic = response.data))
            this.get_comments();
            cm = this.comments
            for (c in this.comments){
                this.comments_and_likes[c] = cm[c]['likes']
            }

        },
        methods:{
            get_comments: function(return_=false){
                self = this
                new_comments = $.ajax({
                    type: "GET",
                    async:false,
                    url: comments_api,
                    dataType: 'json',
                    success: function(data){
                        self.comments = data
                    }
                })
            },
            get_likes_of_comments: function(id){
                return this.comments_and_likes[id];
            },
            onSubmit: function() {
                new_comments = $.ajax({
                    type: "POST",
                    async:false,
                    url: send_comment_api,
                    data: {"text": this.text , 'csrfmiddlewaretoken': '{{ csrf_token }}', },
                    dataType: 'json',
                })
                this.get_comments()
                this.text = ''
            },

            send_like: function(id, num_of_likes, send_like_api, 
                                url_unlike_comment_api){
                var self = this;
                if (!(this.liked)){
                    $.ajax({
                        type: "POST",
                        data: {'csrfmiddlewaretoken': '{{ csrf_token }}'},
                        async:false,
                        url: send_like_api,
                        dataType: 'json',
                        success: function(data){
                            self.liked = true;
                        }
                    })
                    this.comments_and_likes[id] = num_of_likes + 1
                } else {
                    console.log(url_unlike_comment_api)
                    $.ajax({
                        type: "POST",
                        data: {'csrfmiddlewaretoken': '{{ csrf_token }}'},
                        async:false,
                        url: url_unlike_comment_api,
                        dataType: 'json',
                        success: function(data){
                            self.liked = false;
                        }
                    })
                    this.comments_and_likes[id] = num_of_likes - 1
                }
            },
        },

    })    
</script>

{% endblock %}